{% extends "base.html" %}

{% block title %}Games - Cribbage Collection{% endblock %}

{% block content %}
<div class="mb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="page-header">Game Records</h1>
      <p class="text-gray-600">Track and manage your cribbage game history</p>
    </div>
    <button onclick="openModal('addGameModal')" class="btn btn-primary">
      <i class="fas fa-plus"></i>
      Add Game
    </button>
  </div>
</div>

<!-- Search and Filters -->
<div class="card p-4 mb-6">
  <div class="flex gap-4 items-center">
    <div class="flex-1">
      <input type="text" id="searchInput" placeholder="Search games..." class="form-input">
    </div>
    <select id="playerFilter" class="form-input" style="width: auto;">
      <option value="">All Players</option>
      {% for player in players %}
        <option value="{{ player.first_name }} {{ player.last_name }}">{{ player.first_name }} {{ player.last_name }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- Games List -->
<div id="gamesContainer">
  {% if games %}
    <div class="grid grid-cols-1 gap-4">
      {% for game in games %}
        <div class="card game-card" data-player="{{ game.winner or '' }} {{ game.loser or '' }}">
          <div class="p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="text-center">
                  <div class="text-sm text-gray-500">Date</div>
                  <div class="font-medium">{{ game.date_played if game.date_played else 'N/A' }}</div>
                </div>
                
                <div class="text-center">
                  <div class="text-sm text-gray-500">Winner</div>
                  <div class="font-medium text-green-600">
                    {% if game.winner_id %}
                      <a href="{{ url_for('player_detail', player_id=game.winner_id) }}" class="hover:underline">
                        {{ game.winner or 'N/A' }}
                      </a>
                    {% else %}
                      {{ game.winner or 'N/A' }}
                    {% endif %}
                  </div>
                </div>
                
                <div class="text-center">
                  <div class="text-sm text-gray-500">Loser</div>
                  <div class="font-medium text-red-600">
                    {% if game.loser_id %}
                      <a href="{{ url_for('player_detail', player_id=game.loser_id) }}" class="hover:underline">
                        {{ game.loser or 'N/A' }}
                      </a>
                    {% else %}
                      {{ game.loser or 'N/A' }}
                    {% endif %}
                  </div>
                </div>
                
                <div class="text-center">
                  <div class="text-sm text-gray-500">Result</div>
                  <div class="font-medium">
                    {% if game.is_double_skunk %}
                      Double Skunk
                    {% elif game.is_skunk %}
                      Skunk
                    {% else %}
                      Normal Win
                    {% endif %}
                  </div>
                </div>
                
                {% if game.roman_number %}
                  <div class="text-center">
                    <div class="text-sm text-gray-500">Board</div>
                    <div class="font-medium text-blue-600">{{ game.roman_number }}</div>
                  </div>
                {% endif %}
              </div>
              
              <div class="flex gap-2">
                <button onclick="editGame({{ game.id }})" class="btn btn-secondary btn-sm">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteGame({{ game.id }})" class="btn btn-danger btn-sm">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-12">
      <i class="fas fa-gamepad text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-600 mb-2">No games recorded yet</h3>
      <p class="text-gray-500 mb-6">Start tracking your cribbage games and build your game history.</p>
      <button onclick="openModal('addGameModal')" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Record Your First Game
      </button>
    </div>
  {% endif %}
</div>

<!-- Add Game Modal -->
<div id="addGameModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add New Game</h2>
      <button onclick="closeModal('addGameModal')" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form action="{{ url_for('add_game') }}" method="POST">
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Game Date *</label>
          <input type="date" name="date_played" required class="form-input">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Winner *</label>
            <select name="winner_id" required class="form-input">
              <option value="">Select winner</option>
              {% for player in players %}
                <option value="{{ player.id }}">{{ player.first_name }} {{ player.last_name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Loser *</label>
            <select name="loser_id" required class="form-input">
              <option value="">Select loser</option>
              {% for player in players %}
                <option value="{{ player.id }}">{{ player.first_name }} {{ player.last_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Game Result</label>
          <div class="grid grid-cols-3 gap-2">
            <button type="button" onclick="setGameResult('normal')" id="normalBtn" class="btn btn-secondary result-btn">
              Normal Win
            </button>
            <button type="button" onclick="setGameResult('skunk')" id="skunkBtn" class="btn btn-secondary result-btn">
              Skunk
            </button>
            <button type="button" onclick="setGameResult('double_skunk')" id="doubleSkunkBtn" class="btn btn-secondary result-btn">
              Double Skunk
            </button>
          </div>
          <input type="hidden" name="game_result" id="gameResult" value="normal">
          <input type="hidden" name="winner_score" id="winnerScore" value="121">
          <input type="hidden" name="loser_score" id="loserScore" value="0">
        </div>
        
        <div class="form-group">
          <label class="form-label">Board Used</label>
          <select name="board_id" class="form-input">
            <option value="">Select board (optional)</option>
            {% for board in boards %}
              <option value="{{ board.id }}">{{ board.roman_number }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" onclick="closeModal('addGameModal')" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Game</button>
      </div>
    </form>
  </div>
</div>

<script>
// Game result functions
function setGameResult(result) {
  // Reset all buttons
  document.querySelectorAll('.result-btn').forEach(btn => {
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
  });
  
  // Set active button and scores
  let activeBtn;
  let winnerScore = 121;
  let loserScore = 0;
  
  switch(result) {
    case 'normal':
      activeBtn = document.getElementById('normalBtn');
      winnerScore = 121;
      loserScore = 100; // Typical normal game loser score
      break;
    case 'skunk':
      activeBtn = document.getElementById('skunkBtn');
      winnerScore = 121;
      loserScore = 90; // Skunk threshold
      break;
    case 'double_skunk':
      activeBtn = document.getElementById('doubleSkunkBtn');
      winnerScore = 121;
      loserScore = 60; // Double skunk threshold
      break;
  }
  
  if (activeBtn) {
    activeBtn.classList.remove('btn-secondary');
    activeBtn.classList.add('btn-primary');
  }
  
  // Set hidden input values
  document.getElementById('gameResult').value = result;
  document.getElementById('winnerScore').value = winnerScore;
  document.getElementById('loserScore').value = loserScore;
}

// Modal functions
function openModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  // Reset game result to normal when opening modal
  if (modalId === 'addGameModal') {
    setGameResult('normal');
  }
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
  document.body.style.overflow = '';
}

// Search and filter
function filterGames() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const player = document.getElementById('playerFilter').value.toLowerCase();
  const cards = document.querySelectorAll('.game-card');
  
  cards.forEach(card => {
    const cardPlayer = card.dataset.player || '';
    const matchesSearch = cardPlayer.toLowerCase().includes(search);
    const matchesPlayer = !player || cardPlayer.toLowerCase().includes(player);
    
    if (matchesSearch && matchesPlayer) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

document.getElementById('searchInput').addEventListener('input', filterGames);
document.getElementById('playerFilter').addEventListener('change', filterGames);

// Game actions
function editGame(id) {
  window.location.href = `/game/${id}/edit`;
}

function deleteGame(id) {
  if (confirm('Are you sure you want to delete this game record?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/game/${id}/delete`;
    document.body.appendChild(form);
    form.submit();
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.add('hidden');
    document.body.style.overflow = '';
  }
});

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.querySelector('input[name="date_played"]');
  if (dateInput && !dateInput.value) {
    dateInput.valueAsDate = new Date();
  }
});
</script>

<style>
.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}
</style>
{% endblock %}
