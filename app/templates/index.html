{% extends "base.html" %}

{% block title %}Cribbage Board Collection{% endblock %}

{% block content %}
<div class="mb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="page-header">Board Collection</h1>
      <p class="text-gray-600">Manage your cribbage board collection</p>
    </div>
    <button onclick="openModal('addBoardModal')" class="btn btn-primary">
      <i class="fas fa-plus"></i>
      Add Board
    </button>
  </div>
</div>

<!-- Search and Filters -->
<div class="card p-4 mb-6">
  <div class="flex gap-4 items-center">
    <div class="flex-1">
      <input type="text" id="searchInput" placeholder="Search boards..." class="form-input">
    </div>
    <select id="categoryFilter" class="form-input" style="width: auto;">
      <option value="">All Boards</option>
      <option value="in_collection">In Collection</option>
      <option value="not_in_collection">Not In Collection</option>
      <option value="is_gift">Is a Gift</option>
      <option value="gifted_to">Gave as Gift</option>
      <option value="gifted_from">Got as Gift</option>
    </select>
    <div class="flex gap-2">
      <button onclick="setView('grid')" id="gridViewBtn" class="btn btn-secondary">
        <i class="fas fa-th-large"></i>
      </button>
      <button onclick="setView('list')" id="listViewBtn" class="btn btn-secondary">
        <i class="fas fa-list"></i>
      </button>
    </div>
  </div>
</div>

<!-- Boards Grid/List -->
<div id="boardsContainer">
  {% if boards %}
    <div id="boardsGrid" class="grid grid-cols-1 grid-cols-md-2 grid-cols-lg-3 gap-6">
      {% for board in boards %}
        <div class="card board-card" 
             data-name="{{ (board.roman_number or '').lower() }}"
             data-in-collection="{{ board.in_collection }}"
             data-is-gift="{{ board.is_gift }}"
             data-gifted-to="{{ board.gifted_to or '' }}"
             data-gifted-from="{{ board.gifted_from or '' }}">
          {% if board.image_front %}
            <div class="h-48 overflow-hidden rounded-t">
              <img src="{{ url_for('static', filename='uploads/' + board.image_front) }}" 
                   alt="Board {{ board.roman_number }}" class="w-full h-full object-cover">
            </div>
          {% elif board.image_back %}
            <div class="h-48 overflow-hidden rounded-t">
              <img src="{{ url_for('static', filename='uploads/' + board.image_back) }}" 
                   alt="Board {{ board.roman_number }}" class="w-full h-full object-cover">
            </div>
          {% else %}
            <div class="h-48 bg-gray-50 rounded-t flex items-center justify-center">
              <i class="fas fa-chess-board text-4xl text-gray-300"></i>
            </div>
          {% endif %}
          
          <div class="p-4">
            <h3 class="font-semibold text-lg mb-2">
              Board {{ board.roman_number or 'Unnamed' }}
            </h3>
            
            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
              <div><strong>Material:</strong> {{ board.material_type or 'N/A' }}</div>
              <div><strong>Wood Type:</strong> {{ board.wood_type or 'N/A' }}</div>
              <div><strong>Collection:</strong> {{ 'Yes' if board.in_collection == 1 else 'No' }}</div>
              <div><strong>Gift:</strong> {{ 'Yes' if board.is_gift == 1 else 'No' }}</div>
            </div>
            
            {% if board.description %}
              <p class="text-sm text-gray-600 mb-4">{{ board.description[:100] }}{% if board.description|length > 100 %}...{% endif %}</p>
            {% endif %}
            
            <div class="flex gap-2">
              <a href="{{ url_for('board_detail', board_id=board.id) }}" class="btn btn-primary flex-1 justify-center">
                <i class="fas fa-eye"></i>
                View
              </a>
              <button onclick="editBoard({{ board.id }})" class="btn btn-secondary">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteBoard({{ board.id }})" class="btn btn-danger">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <!-- List View (Hidden by default) -->
    <div id="boardsList" class="hidden">
      <div class="card">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-3 text-left font-medium text-gray-700">Image</th>
              <th class="p-3 text-left font-medium text-gray-700">Board</th>
              <th class="p-3 text-left font-medium text-gray-700">Material</th>
              <th class="p-3 text-left font-medium text-gray-700">Wood Type</th>
              <th class="p-3 text-left font-medium text-gray-700">Collection</th>
              <th class="p-3 text-left font-medium text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for board in boards %}
              <tr class="border-t board-row" 
                  data-name="{{ (board.roman_number or '').lower() }}"
                  data-in-collection="{{ board.in_collection }}"
                  data-is-gift="{{ board.is_gift }}"
                  data-gifted-to="{{ board.gifted_to or '' }}"
                  data-gifted-from="{{ board.gifted_from or '' }}">
                <td class="p-3">
                  {% if board.image_front %}
                    <img src="{{ url_for('static', filename='uploads/' + board.image_front) }}" 
                         alt="Board {{ board.roman_number }}" class="w-12 h-12 object-cover rounded">
                  {% elif board.image_back %}
                    <img src="{{ url_for('static', filename='uploads/' + board.image_back) }}" 
                         alt="Board {{ board.roman_number }}" class="w-12 h-12 object-cover rounded">
                  {% else %}
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
                      <i class="fas fa-chess-board text-gray-400"></i>
                    </div>
                  {% endif %}
                </td>
                <td class="p-3 font-medium">Board {{ board.roman_number or 'Unnamed' }}</td>
                <td class="p-3 text-gray-600">{{ board.material_type or 'N/A' }}</td>
                <td class="p-3 text-gray-600">{{ board.wood_type or 'N/A' }}</td>
                <td class="p-3 text-gray-600">{{ 'Yes' if board.in_collection == 1 else 'No' }}</td>
                <td class="p-3">
                  <div class="flex gap-1">
                    <a href="{{ url_for('board_detail', board_id=board.id) }}" class="btn btn-primary btn-sm">
                      <i class="fas fa-eye"></i>
                    </a>
                    <button onclick="editBoard({{ board.id }})" class="btn btn-secondary btn-sm">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteBoard({{ board.id }})" class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="text-center py-12">
      <i class="fas fa-chess-board text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-600 mb-2">No boards in your collection</h3>
      <p class="text-gray-500 mb-6">Start building your cribbage board collection by adding your first board.</p>
      <button onclick="openModal('addBoardModal')" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Your First Board
      </button>
    </div>
  {% endif %}
</div>

<!-- Add Board Modal -->
<div id="addBoardModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add New Board</h2>
      <button onclick="closeModal('addBoardModal')" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form action="{{ url_for('add_board') }}" method="POST" enctype="multipart/form-data">
      <div class="modal-body">
        <div class="form-group mb-4">
          <label class="form-label">Roman Number *</label>
          <input type="text" name="roman_number" required class="form-input" placeholder="e.g., I, II, III, IV">
        </div>

        <div class="form-group mb-4">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-input" rows="2" placeholder="Brief description of the board"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label class="form-label">Date (MM/DD/YYYY)</label>
            <input type="text" name="date" class="form-input" placeholder="MM/DD/YYYY">
          </div>
          
          <div class="form-group">
            <label class="form-label">In Collection</label>
            <select name="in_collection" class="form-input">
              <option value="1">Yes - In Collection</option>
              <option value="0">No - Not in Collection</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label class="form-label">Material Type</label>
            <select name="material_type" class="form-input" onchange="toggleModalWoodType(this.value); toggleCustomMaterial(this.value)">
              <option value="">Select material</option>
              <option value="Wood">Wood</option>
              <option value="Plastic">Plastic</option>
              <option value="Metal">Metal</option>
              <option value="Other">Other (specify)</option>
            </select>
            <input type="text" name="custom_material_type" id="modal-custom-material" class="form-input mt-2" placeholder="Enter custom material type" style="display: none;">
          </div>
          
          <div class="form-group" id="modal-wood-type-group" style="display: none;">
            <label class="form-label">Wood Type</label>
            <select name="wood_type" class="form-input" onchange="toggleCustomWood(this.value)">
              <option value="">Select wood type</option>
              <option value="Oak">Oak</option>
              <option value="Maple">Maple</option>
              <option value="Cherry">Cherry</option>
              <option value="Walnut">Walnut</option>
              <option value="Pine">Pine</option>
              <option value="Cedar">Cedar</option>
              <option value="Mahogany">Mahogany</option>
              <option value="Other">Other (specify)</option>
            </select>
            <input type="text" name="custom_wood_type" id="modal-custom-wood" class="form-input mt-2" placeholder="Enter custom wood type" style="display: none;">
          </div>
        </div>

        <div class="form-group mb-4">
          <label class="form-label">Is Gift?</label>
          <select name="is_gift" class="form-input" onchange="toggleModalGiftFields(this.value)">
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>

        <div id="modal-gift-fields" style="display: none;">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label class="form-label">Gifted To</label>
              <input type="text" name="gifted_to" class="form-input" placeholder="Person's name">
            </div>
            
            <div class="form-group">
              <label class="form-label">Gifted From</label>
              <input type="text" name="gifted_from" class="form-input" placeholder="Person's name">
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label class="form-label">Front Image</label>
            <input type="file" name="front_view" accept="image/*" class="form-input">
          </div>
          
          <div class="form-group">
            <label class="form-label">Back Image</label>
            <input type="file" name="back_view" accept="image/*" class="form-input">
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" onclick="closeModal('addBoardModal')" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Board</button>
      </div>
    </form>
  </div>
</div>

<script>
// Modal functions
function openModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
  document.body.style.overflow = '';
}

// Modal form functions
function toggleModalWoodType(material) {
  const woodTypeGroup = document.getElementById('modal-wood-type-group');
  if (material === 'Wood') {
    woodTypeGroup.style.display = 'block';
  } else {
    woodTypeGroup.style.display = 'none';
    // Clear the wood type selection when material is not wood
    const woodTypeSelect = woodTypeGroup.querySelector('select[name="wood_type"]');
    const customWoodInput = document.getElementById('modal-custom-wood');
    if (woodTypeSelect) {
      woodTypeSelect.value = '';
    }
    if (customWoodInput) {
      customWoodInput.style.display = 'none';
      customWoodInput.value = '';
    }
  }
}

function toggleCustomMaterial(material) {
  const customInput = document.getElementById('modal-custom-material');
  if (material === 'Other') {
    customInput.style.display = 'block';
    customInput.required = true;
  } else {
    customInput.style.display = 'none';
    customInput.required = false;
    customInput.value = '';
  }
}

function toggleCustomWood(woodType) {
  const customInput = document.getElementById('modal-custom-wood');
  if (woodType === 'Other') {
    customInput.style.display = 'block';
    customInput.required = true;
  } else {
    customInput.style.display = 'none';
    customInput.required = false;
    customInput.value = '';
  }
}

function toggleModalGiftFields(isGift) {
  const giftFields = document.getElementById('modal-gift-fields');
  if (isGift === '1') {
    giftFields.style.display = 'block';
  } else {
    giftFields.style.display = 'none';
    // Clear the gift fields when not a gift
    const giftToInput = giftFields.querySelector('input[name="gifted_to"]');
    const giftFromInput = giftFields.querySelector('input[name="gifted_from"]');
    if (giftToInput) giftToInput.value = '';
    if (giftFromInput) giftFromInput.value = '';
  }
}

// View toggle
let currentView = 'grid';

function setView(view) {
  currentView = view;
  const grid = document.getElementById('boardsGrid');
  const list = document.getElementById('boardsList');
  const gridBtn = document.getElementById('gridViewBtn');
  const listBtn = document.getElementById('listViewBtn');
  
  if (view === 'grid') {
    grid.classList.remove('hidden');
    list.classList.add('hidden');
    gridBtn.classList.add('btn-primary');
    gridBtn.classList.remove('btn-secondary');
    listBtn.classList.add('btn-secondary');
    listBtn.classList.remove('btn-primary');
  } else {
    grid.classList.add('hidden');
    list.classList.remove('hidden');
    listBtn.classList.add('btn-primary');
    listBtn.classList.remove('btn-secondary');
    gridBtn.classList.add('btn-secondary');
    gridBtn.classList.remove('btn-primary');
  }
}

// Search and filter
function filterBoards() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const filter = document.getElementById('categoryFilter').value;
  
  const cards = document.querySelectorAll('.board-card');
  const rows = document.querySelectorAll('.board-row');
  
  cards.forEach(card => {
    const name = card.dataset.name || '';
    const matchesSearch = name.includes(search);
    
    let matchesFilter = true;
    if (filter) {
      switch(filter) {
        case 'in_collection':
          matchesFilter = card.dataset.inCollection === '1';
          break;
        case 'not_in_collection':
          matchesFilter = card.dataset.inCollection === '0';
          break;
        case 'is_gift':
          matchesFilter = card.dataset.isGift === '1';
          break;
        case 'gifted_to':
          matchesFilter = card.dataset.giftedTo && card.dataset.giftedTo.trim() !== '';
          break;
        case 'gifted_from':
          matchesFilter = card.dataset.giftedFrom && card.dataset.giftedFrom.trim() !== '';
          break;
      }
    }
    
    if (matchesSearch && matchesFilter) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
  
  rows.forEach(row => {
    const name = row.dataset.name || '';
    const matchesSearch = name.includes(search);
    
    let matchesFilter = true;
    if (filter) {
      switch(filter) {
        case 'in_collection':
          matchesFilter = row.dataset.inCollection === '1';
          break;
        case 'not_in_collection':
          matchesFilter = row.dataset.inCollection === '0';
          break;
        case 'is_gift':
          matchesFilter = row.dataset.isGift === '1';
          break;
        case 'gifted_to':
          matchesFilter = row.dataset.giftedTo && row.dataset.giftedTo.trim() !== '';
          break;
        case 'gifted_from':
          matchesFilter = row.dataset.giftedFrom && row.dataset.giftedFrom.trim() !== '';
          break;
      }
    }
    
    if (matchesSearch && matchesFilter) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

document.getElementById('searchInput').addEventListener('input', filterBoards);
document.getElementById('categoryFilter').addEventListener('change', filterBoards);

// Board actions
function editBoard(id) {
  window.location.href = `/edit_board/${id}`;
}

function deleteBoard(id) {
  if (confirm('Are you sure you want to delete this board?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/delete_board/${id}`;
    document.body.appendChild(form);
    form.submit();
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.add('hidden');
    document.body.style.overflow = '';
  }
});

// Initialize grid view
setView('grid');
</script>

<style>
.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}
</style>
{% endblock %}